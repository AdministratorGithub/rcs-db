#!/usr/bin/env ruby

require 'fssm'
require 'colorize'

$root_path = File.expand_path File.join(File.dirname(__FILE__), '..')
$spec_path = File.join $root_path, 'tests/rspec'

def log msg
  puts msg.colorize :light_blue
end

def spec filepath
  spec_filepath = File.join $root_path, filepath
  cmd = "cd \"#{$root_path}\"; rspec -I tests/rspec --color --format doc \"#{spec_filepath}\""
  system cmd
end

def changed filepath
  log "The file #{filepath} has changed!"

  if filepath =~ /.*_spec.rb/
    spec filepath
  else
    spec_filepath = "tests/rspec/" + filepath.gsub('.rb', '_spec.rb')
    spec spec_filepath if File.exists?(spec_filepath)
  end
end

def monitor path
  log "Watching for changes #{path}..."
  FSSM.monitor(path, '*.rb') do
    update { |f, r| changed(r) }
  end
end

monitor $root_path
